<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Snake & Ladder</title>

<style>
body{
  margin:0;
  font-family:Arial, sans-serif;
  background:#fdf6aa;
}

#leaderboard{
  position:fixed;
  top:15px;
  right:15px;
  background:white;
  padding:12px;
  border-radius:10px;
  box-shadow:0 4px 10px rgba(0,0,0,0.2);
  font-size:14px;
  min-width:160px;
  max-height:60vh;
  overflow-y:auto;
}

#boardWrapper{
  position:relative;
  width:min(90vw,600px);
  height:min(90vw,600px);
  margin:auto;
}

#board{
  width:100%;
  height:100%;
  display:grid;
  grid-template-columns:repeat(10,1fr);
  grid-template-rows:repeat(10,1fr);
}

.cell{
  border:2px solid black;
  display:flex;
  justify-content:center;
  align-items:center;
  font-weight:bold;
  font-size:2vmin;
  position:relative;
}

.player{
  width:60%;
  height:60%;
  border-radius:50%;
  position:absolute;
  bottom:5%;
}

#questionScreen{
  position:absolute;
  top:0;
  left:0;
  width:100%;
  height:100%;
  background:rgba(0,0,0,0.4);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:50;
}

#questionBox{
  width:80%;
  max-width:400px;
  background:white;
  padding:20px;
  border-radius:14px;
  text-align:center;
}

#choices button{
  margin:5px 0;
  padding:10px;
  border:none;
  border-radius:8px;
  background:#2196f3;
  color:white;
  cursor:pointer;
}
</style>
</head>

<body>

<h2 style="text-align:center;">‡πÄ‡∏Å‡∏°‡∏á‡∏π‡∏ö‡∏±‡∏ô‡πÑ‡∏î</h2>

<div id="leaderboard"></div>

<div style="text-align:center; margin-bottom:10px;">
  <button onclick="getQuestion()" id="questionBtn">
    QUESTION HERE
  </button>
</div>

<div id="boardWrapper">
  <div id="board"></div>

  <div id="questionScreen">
    <div id="questionBox">
      <div id="questionText"></div>
      <div id="choices"></div>
    </div>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>

const socket = io();
let myId = null;
let animatingPlayerId = null;
let isAnimating = false;
let questionOpen = false;

socket.on("connect", ()=>{
  myId = socket.id;
});

const board = document.getElementById("board");
const lb = document.getElementById("leaderboard");

const name = localStorage.getItem("playerName");
const room = localStorage.getItem("roomName");
if(!name){ window.location.href="index.html"; }
socket.emit("newPlayer",{name,room});

/* ===== ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏ô ===== */
for(let row=9;row>=0;row--){
  for(let col=0;col<10;col++){
    const cell=document.createElement("div");
    cell.className="cell";

    let number;
    if(row%2===0){
      number=row*10+col+1;
    }else{
      number=row*10+(9-col)+1;
    }

    cell.id="cell-"+number;
    cell.innerText=number;
    cell.style.background=(row+col)%2===0?"#e3f2fd":"#90caf9";
    board.appendChild(cell);
  }
}

/* ===== ‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° ===== */
function getQuestion(){
  if(questionOpen||isAnimating) return;
  questionOpen=true;
  document.getElementById("questionBtn").disabled=true;
  socket.emit("getQuestion");
}

/* ===== ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° ===== */
socket.on("showQuestion",(data)=>{
  document.getElementById("questionText").innerText=data.question;
  const choicesDiv=document.getElementById("choices");
  choicesDiv.innerHTML="";

  data.choices.forEach(choice=>{
    const btn=document.createElement("button");
    btn.innerText=choice;
    btn.onclick=()=>{
      document.querySelectorAll("#choices button")
        .forEach(b=>b.disabled=true);
      socket.emit("answer",choice);
    };
    choicesDiv.appendChild(btn);
  });

  document.getElementById("questionScreen").style.display="flex";
});

/* ===== updatePlayers ===== */
socket.on("updatePlayers",(players)=>{

  lb.innerHTML="";

  const sorted=Object.entries(players)
    .sort((a,b)=>b[1].position-a[1].position);

  sorted.forEach(([id,player],index)=>{

    const isMe=id===myId;

    lb.innerHTML+=`
      <div>
        #${index+1} -
        <span style="color:${player.color};font-weight:bold;">
          ${isMe ? "YOU" : player.name}
        </span>
        (${player.position})
      </div>
    `;

    let piece=document.getElementById("player-"+id);
    if(!piece){
      piece=document.createElement("div");
      piece.className="player";
      piece.id="player-"+id;
      piece.style.background=player.color;
    }

    if(id===animatingPlayerId) return;

    const cell=document.getElementById("cell-"+player.position);
    if(cell) cell.appendChild(piece);
  });
});

/* ===== animation ===== */
function sleep(ms){return new Promise(r=>setTimeout(r,ms));}

async function animateMove(playerId,from,to){
  const piece=document.getElementById("player-"+playerId);
  if(!piece) return;

  const step=from<to?1:-1;
  let current=from;

  while(current!==to){
    current+=step;
    const cell=document.getElementById("cell-"+current);
    if(cell) cell.appendChild(piece);
    await sleep(300);
  }
}

/* ===== answerResult ===== */
socket.on("answerResult",async(data)=>{

  animatingPlayerId=data.playerId;
  isAnimating=true;

  const isMe=data.playerId===myId;

  if(isMe){
    const box=document.getElementById("questionBox");
    box.innerHTML=`
      <div style="font-weight:bold;font-size:20px;">
        ${data.correct?"‡∏ï‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å üéâ":"‡∏ï‡∏≠‡∏ö‡∏ú‡∏¥‡∏î üò¢"}
      </div>
      <div>üé≤ ${data.dice}</div>
    `;
    await sleep(1200);
    document.getElementById("questionScreen").style.display="none";
  }

  await animateMove(data.playerId,data.start,data.afterDice);

  const piece=document.getElementById("player-"+data.playerId);
  const finalCell=document.getElementById("cell-"+data.finalPosition);
  if(finalCell && piece) finalCell.appendChild(piece);

  animatingPlayerId=null;
  isAnimating=false;

  if(isMe){
    questionOpen=false;
    document.getElementById("questionBtn").disabled=false;
  }
});

</script>
</body>
</html>
